package dev.rubentxu.pipeline.cli

import com.github.ajalt.clikt.core.CliktCommand
import com.github.ajalt.clikt.parameters.options.choice
import com.github.ajalt.clikt.parameters.options.option
import com.github.ajalt.mordant.rendering.TextColors.*
import com.github.ajalt.mordant.rendering.TextStyles.*
import com.github.ajalt.mordant.widgets.Panel
import com.github.ajalt.mordant.table.table

/**
 * Advanced help system with examples and tips
 */
object HelpSystem {
    
    fun getQuickStart(): String = Panel.fit("""
        ${bold(cyan("ðŸš€ Quick Start Guide"))}
        
        ${yellow("1. Run your first pipeline:")}
        ${dim("   pipeline run examples/hello.kts")}
        
        ${yellow("2. List available pipelines:")}
        ${dim("   pipeline get pipelines")}
        
        ${yellow("3. Analyze a pipeline:")}
        ${dim("   pipeline describe build.kts")}
        
        ${yellow("4. Configure CLI:")}
        ${dim("   pipeline config set user.name \"Your Name\"")}
        
        ${yellow("5. Enable auto-completion:")}
        ${dim("   pipeline completion bash >> ~/.bashrc")}
        
        ${green("ðŸ’¡ Tip:")} Use ${yellow("--help")} with any command for detailed help
    """.trimIndent())
    
    fun getAdvancedExamples(): String = Panel.fit("""
        ${bold(cyan("ðŸŽ¯ Advanced Examples"))}
        
        ${yellow("Continuous Integration Pipeline:")}
        ${dim("   pipeline run ci.kts --watch --retry 3")}
        
        ${yellow("Production Deployment:")}
        ${dim("   pipeline run deploy.kts --config prod.yaml --timeout 1800")}
        
        ${yellow("Development with Hot Reload:")}
        ${dim("   pipeline run dev.kts --watch --verbose")}
        
        ${yellow("Dry Run for Testing:")}
        ${dim("   pipeline run complex.kts --dry-run --validate")}
        
        ${yellow("Pipeline Analysis:")}
        ${dim("   pipeline describe pipeline.kts --syntax --validate")}
        
        ${yellow("Bulk Operations:")}
        ${dim("   pipeline get pipelines --filter '.*test.*' --output json")}
    """.trimIndent())
    
    fun getTroubleshootingGuide(): String = Panel.fit("""
        ${bold(red("ðŸ”§ Troubleshooting Guide"))}
        
        ${yellow("Common Issues & Solutions:")}
        
        ${cyan("1. Pipeline fails to execute:")}
        ${dim("   â€¢ Check file permissions: chmod +x pipeline.kts")}
        ${dim("   â€¢ Validate syntax: pipeline describe --validate pipeline.kts")}
        ${dim("   â€¢ Run with debug: pipeline run --log-level DEBUG pipeline.kts")}
        
        ${cyan("2. Configuration not found:")}
        ${dim("   â€¢ Create default config: mkdir -p ~/.pipeline")}
        ${dim("   â€¢ Check config path: pipeline config list")}
        ${dim("   â€¢ Use explicit config: pipeline run --config path/to/config.yaml")}
        
        ${cyan("3. Slow execution:")}
        ${dim("   â€¢ Increase timeout: pipeline run --timeout 3600 pipeline.kts")}
        ${dim("   â€¢ Check resource usage: pipeline describe --syntax pipeline.kts")}
        ${dim("   â€¢ Use verbose mode: pipeline run --verbose pipeline.kts")}
        
        ${cyan("4. Auto-completion not working:")}
        ${dim("   â€¢ Generate completion: pipeline completion bash > completion.sh")}
        ${dim("   â€¢ Source it: source completion.sh")}
        ${dim("   â€¢ Add to profile: echo 'source completion.sh' >> ~/.bashrc")}
        
        ${green("ðŸ’¡ Still having issues?")} Use ${yellow("--verbose")} flag for detailed logs
    """.trimIndent())
    
    fun getBestPractices(): String = Panel.fit("""
        ${bold(green("âœ¨ Best Practices"))}
        
        ${yellow("Pipeline Structure:")}
        ${dim("   â€¢ Use descriptive stage names")}
        ${dim("   â€¢ Add error handling with post blocks")}
        ${dim("   â€¢ Keep stages focused and atomic")}
        ${dim("   â€¢ Use parallel execution for independent tasks")}
        
        ${yellow("Configuration Management:")}
        ${dim("   â€¢ Store sensitive data in config files, not scripts")}
        ${dim("   â€¢ Use environment-specific configs (dev, staging, prod)")}
        ${dim("   â€¢ Version control your configuration")}
        
        ${yellow("Development Workflow:")}
        ${dim("   â€¢ Use --dry-run to test changes")}
        ${dim("   â€¢ Enable --watch during development")}
        ${dim("   â€¢ Use descriptive commit messages")}
        ${dim("   â€¢ Add validation steps to your pipelines")}
        
        ${yellow("Performance:")}
        ${dim("   â€¢ Set appropriate timeouts")}
        ${dim("   â€¢ Use caching for repeated operations")}
        ${dim("   â€¢ Monitor execution times")}
        ${dim("   â€¢ Profile resource usage")}
        
        ${yellow("Debugging:")}
        ${dim("   â€¢ Start with --verbose for troubleshooting")}
        ${dim("   â€¢ Use pipeline describe for analysis")}
        ${dim("   â€¢ Check logs in ~/.pipeline/logs/")}
        ${dim("   â€¢ Test with minimal examples first")}
    """.trimIndent())
    
    fun getFeatureMatrix(): String = """
        ${bold(cyan("ðŸ“‹ Feature Matrix"))}
        
        ${table {
            header {
                row(bold("Feature"), bold("Status"), bold("Description"))
            }
            body {
                row(green("âœ… Pipeline Execution"), green("Stable"), "Execute Kotlin DSL pipelines")
                row(green("âœ… Configuration"), green("Stable"), "Manage CLI and pipeline settings")
                row(green("âœ… Auto-completion"), green("Stable"), "Shell completion for all commands")
                row(green("âœ… Rich Output"), green("Stable"), "Colored, formatted terminal output")
                row(green("âœ… Progress Tracking"), green("Stable"), "Real-time execution progress")
                row(green("âœ… Validation"), green("Stable"), "Pipeline syntax and structure validation")
                row(yellow("ðŸ”„ Watch Mode"), yellow("Beta"), "Hot reload on file changes")
                row(yellow("ðŸ”„ Plugin System"), yellow("Beta"), "Extensible plugin architecture")
                row(blue("ðŸš§ History"), blue("Planned"), "Execution history and analytics")
                row(blue("ðŸš§ Remote Execution"), blue("Planned"), "Execute pipelines on remote systems")
                row(blue("ðŸš§ Web Dashboard"), blue("Planned"), "Web-based pipeline management")
            }
        }}
    """.trimIndent()
    
    fun getKeyboardShortcuts(): String = Panel.fit("""
        ${bold(yellow("âŒ¨ï¸  Keyboard Shortcuts & Tips"))}
        
        ${cyan("Interactive Mode:")}
        ${dim("   Ctrl+C        # Interrupt execution")}
        ${dim("   Ctrl+Z        # Suspend process")}
        ${dim("   Tab           # Auto-complete commands and files")}
        
        ${cyan("Shell Integration:")}
        ${dim("   pipeline !!   # Run last pipeline command")}
        ${dim("   alias p=pipeline  # Create short alias")}
        ${dim("   export PIPELINE_CONFIG=~/.pipeline/config.yaml")}
        
        ${cyan("Useful Aliases:")}
        ${dim("   alias pr='pipeline run'")}
        ${dim("   alias pg='pipeline get'")}
        ${dim("   alias pd='pipeline describe'")}
        ${dim("   alias pc='pipeline config'")}
        
        ${cyan("Environment Variables:")}
        ${dim("   PIPELINE_HOME     # Override default config directory")}
        ${dim("   PIPELINE_VERBOSE  # Enable verbose mode by default")}
        ${dim("   PIPELINE_TIMEOUT  # Set default timeout")}
        
        ${green("ðŸ’¡ Pro Tip:")} Add these to your ${yellow("~/.bashrc")} or ${yellow("~/.zshrc")}
    """.trimIndent())
}

/**
 * Interactive help command with multiple sections
 */
class HelpCommand : CliktCommand(
    name = "help",
    help = "Show comprehensive help and documentation"
) {
    
    private val section by option(
        "--section", "-s",
        help = "Show specific help section"
    ).choice(
        "quick-start", "examples", "troubleshooting", 
        "best-practices", "features", "shortcuts"
    )
    
    override fun run() {
        val terminal = currentContext.terminal
        
        when (section) {
            "quick-start" -> terminal.println(HelpSystem.getQuickStart())
            "examples" -> terminal.println(HelpSystem.getAdvancedExamples())
            "troubleshooting" -> terminal.println(HelpSystem.getTroubleshootingGuide())
            "best-practices" -> terminal.println(HelpSystem.getBestPractices())
            "features" -> terminal.println(HelpSystem.getFeatureMatrix())
            "shortcuts" -> terminal.println(HelpSystem.getKeyboardShortcuts())
            null -> showAllHelp(terminal)
        }
    }
    
    private fun showAllHelp(terminal: Terminal) {
        terminal.println(HelpSystem.getQuickStart())
        terminal.println()
        terminal.println(HelpSystem.getAdvancedExamples())
        terminal.println()
        
        terminal.println(Panel.fit("""
            ${bold(blue("ðŸ“š More Help Sections"))}
            
            ${dim("Use --section to view specific help:")}
            ${dim("  pipeline help --section troubleshooting")}
            ${dim("  pipeline help --section best-practices")}
            ${dim("  pipeline help --section features")}
            ${dim("  pipeline help --section shortcuts")}
            
            ${dim("For command-specific help:")}
            ${dim("  pipeline run --help")}
            ${dim("  pipeline get --help")}
            ${dim("  pipeline describe --help")}
        """.trimIndent()))
    }
}